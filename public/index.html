<html>
  <head>
    <title>Affective Computing Project</title>
  </head>
  <body>
    <video id="video"></video>
    <canvas id="canvas"></canvas>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import { getStorage, ref, uploadString } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAFlE1-z280atVYvoCdirQwBjolPDjksBA",
        authDomain: "affective-computing-proj-48220.firebaseapp.com",
        databaseURL: "https://affective-computing-proj-48220-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "affective-computing-proj-48220",
        storageBucket: "affective-computing-proj-48220.appspot.com",
        messagingSenderId: "1084466855468",
        appId: "1:1084466855468:web:7e25dcbd77af8a8c52db89",
        measurementId: "G-363YKWWSE7"
      };

      const app = initializeApp(firebaseConfig);
      const storage = getStorage(app);

      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");

      video.onloadedmetadata = function () {
        const ratio = video.videoHeight / video.videoWidth;
        const max_width = 640;
        const max_height = max_width * ratio;

        video.width = max_width;
        video.height = max_height;

        canvas.width = max_width;
        canvas.height = max_height;

        video.play();
        loop();
      };

      function snap() {
        canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
        const data_url = canvas.toDataURL("image/jpeg");

        const storage_ref_name = `${Date.now()}.jpeg`;
        const storage_ref = ref(storage, storage_ref_name);
          
        uploadString(storage_ref, data_url, "data_url")
          .then((snapshot) => {
            console.log(`Uploaded ${storage_ref_name}`);
          })
          .catch((err) => {
            console.log(err);
          });
      };

      function loop() {
        snap();
        setTimeout(loop, 5000);
      };

      navigator.mediaDevices
        .getUserMedia({
          audio: false,
          video: true
        })
        .then((stream) => {
          video.srcObject = stream;
        })
        .catch((err) => {
          console.log(err);
        });
    </script>
  </body>
</html>